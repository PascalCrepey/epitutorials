---
title: Lab - Manipulation de données et visualisation interactive
author: Pascal Crépey
date: '`r format(Sys.time(), "%d %B, %Y")`'
tutorial:
  id: data-visualization
output:
  learnr::tutorial:
    progressive: yes
    allow_skip: yes
runtime: shiny_prerendered
description: Ce tutoriel a pour objectif de vous familiariser avec la librairie data.table,
  de charger des données directement depuis une URL, d'ajouter une colonne dans une
  data.table et de visualiser des données de manière interactive.
---

```{r setup, include = FALSE}
library(learnr)
library(tutorial.helpers)
library(epitutorials)
library(knitr)
library(tidyverse)
library(ggthemes) 
library(data.table)
library(ggplot2)
library(geodata)
library(sf)

# dtbaseAllHosp = fread("https://www.data.gouv.fr/fr/datasets/r/6fadff46-9efd-4c53-942a-54aca783c30c")
# usethis::use_data(dtbaseAllHosp, overwrite = TRUE)

mydata = copy(dtbaseAllHosp)

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(out.width = '90%')
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 
```

```{r copy-code-chunk, child = system.file("child_documents/copy_button.Rmd", package = "tutorial.helpers")}
```

```{r info-section, child = system.file("child_documents/info_section.Rmd", package = "tutorial.helpers")}
```

## Introduction
### 

Ce tutoriel a pour objectif de vous familiariser avec la librairie data.table, de charger des données directement depuis une URL, d'ajouter une colonne dans une data.table et de visualiser des données sur une carte et de manière interactive.

## Découvrir data.table
### 

La librairie data.table est une extension de la librairie de base de R qui permet de manipuler des données de manière plus efficace que les data.frame. Elle est particulièrement adaptée pour manipuler de grandes quantités de données.

Cliquez sur le lien vers la documentation de la librairie data.table pour pouvoir la consulter au besoin: [https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro.html](https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro.html)

Cliquez sur le lien vers la cheatsheet de data.table pour voir une synthèse de ses usages: [https://s3.amazonaws.com/assets.datacamp.com/blog_assets/datatable_Cheat_Sheet_R.pdf](https://s3.amazonaws.com/assets.datacamp.com/blog_assets/datatable_Cheat_Sheet_R.pdf)


### Exercise 1

Chargez la librairie data.table

```{r dcouvrir-datatable-1, exercise = TRUE}

```

```{r dcouvrir-datatable-1-hint-1, eval = FALSE}
# Utilisez la fonction library() pour charger la librairie data.table
library(...)
```

```{r dcouvrir-datatable-1-test, include = FALSE}
library(data.table)
```

### Exercise 2

Nous voulons télécharger des données directement depuis une URL. Pour cela, nous allons utiliser la fonction `fread()` de la librairie data.table. 
L'URL utilisée est la suivante : [https://www.data.gouv.fr/fr/datasets/r/6fadff46-9efd-4c53-942a-54aca783c30c](https://www.data.gouv.fr/fr/datasets/r/6fadff46-9efd-4c53-942a-54aca783c30c) et nous voulons stocker ces données dans un objet nommé `mydata`.


```{r dcouvrir-datatable-2, exercise = TRUE}

```

```{r dcouvrir-datatable-2-hint-1, eval = FALSE}
mydata = fread("https://www.data.gouv.fr/fr/datasets/r/6fadff46-9efd-4c53-942a-54aca783c30c")
```

```{r dcouvrir-datatable-2-test, include = FALSE}
mydata = fread("https://www.data.gouv.fr/fr/datasets/r/6fadff46-9efd-4c53-942a-54aca783c30c")
```

### Exercise 3

Tapez `mydata` dans la console pour afficher le contenu de l'objet.

```{r dcouvrir-datatable-3, exercise = TRUE}

```

```{r dcouvrir-datatable-3-hint-1, eval = FALSE}
mydata
```

```{r dcouvrir-datatable-3-test, include = FALSE}
mydata
```

### 

Vous pouvez voir que les données sont stockées dans un objet de type data.table et que celles-ci ont des types adaptés (int, chr, IDate). Si vous voulez en savoir plus sur ces types, vous pouvez tapez `?int` par exemple, dans la console.


### Exercise 4

Utilisez la fonction `str()` pour afficher la structure des données stockées dans l'objet `mydata`.


```{r dcouvrir-datatable-4, exercise = TRUE}

```

```{r dcouvrir-datatable-4-hint-1, eval = FALSE}
str(...)
```

```{r dcouvrir-datatable-4-test, include = FALSE}
str(mydata)
```

### Exercise 5

Combien y a-t-il de lignes dans les données stockées dans l'objet `mydata`?

```{r dcouvrir-datatable-5}
question_text(NULL,
	message = "La bonne réponse est ",
	answer(11306, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 1)
```

### 

Il est important avant de commencer à analyser des données d'en connaitre la source, et de se renseigner sur les variables disponibles. Dans notre cas, les données proviennent de la plateforme data.gouv.fr et concernent les hospitalisations et les décès liés au Covid-19 en France. Allez visiter ce lien pour en savoir plus sur ces données: [https://www.data.gouv.fr/fr/datasets/donnees-hospitalieres-relatives-a-lepidemie-de-covid-19/](https://www.data.gouv.fr/fr/datasets/donnees-hospitalieres-relatives-a-lepidemie-de-covid-19/).

### Exercise 6

Faites un copier/coller du paragraphe correspondant à la description des données hospitalières relatives à l'épidémie de Covid-19 en France (un des 5 proposés).

```{r dcouvrir-datatable-6}
question_text(NULL,
	message = "Place correct answer here.",
	answer("Les données hospitalières quotidiennes relatives à l'épidémie du COVID-19 par département : nombre quotidien de personnes nouvellement hospitalisées, nombre quotidien de nouvelles admissions en réanimation, nombre quotidien de personnes nouvellement décédées, nombre quotidien de nouveaux retours à domicile.", correct = TRUE),
	allow_retry = TRUE,
	incorrect = "Ce n'est pas la bonne réponse.",
	rows = 6)
```

## Explorer les données
### 

Nous allons maintenant utiliser le package DataExplorer pour explorer les données stockées dans l'objet `mydata`.
Le package DataExplorer permet de générer des graphiques et des statistiques descriptives pour explorer les données.
Il contient notamment des fonctions pour visualiser les données manquantes, les distributions des variables, les corrélations, etc. 
Vous pouvez consulter la documentation de DataExplorer pour en savoir plus sur ses fonctionnalités: [https://boxuancui.github.io/DataExplorer/](https://boxuancui.github.io/DataExplorer/)

### Exercise 1

Chargez la librairie DataExplorer.

```{r explorer-les-donnes-1, exercise = TRUE}

```

```{r explorer-les-donnes-1-hint-1, eval = FALSE}
library(...)
```

```{r explorer-les-donnes-1-test, include = FALSE}
library(DataExplorer)
```

### Exercise 2

Utilisez la fonction `plot_intro()` de DataExplorer pour afficher un résumé des données stockées dans l'objet `mydata`.

```{r explorer-les-donnes-2, exercise = TRUE}

```

```{r explorer-les-donnes-2-hint-1, eval = FALSE}
plot_intro(...)
```

```{r explorer-les-donnes-2-test, include = FALSE}
plot_intro(mydata)
```

### Exercise 3

Combien y a-t-il de variables continues dans les données stockées dans l'objet `mydata`?

```{r explorer-les-donnes-3}
question_text(NULL,
	answer(4, correct = TRUE),
	allow_retry = TRUE,
	incorrect = "Ce n'est pas la bonne réponse.",
	rows = 1)
```

### Exercise 4

Utilisez la fonction `plot_missing()` de DataExplorer pour afficher un graphique des données manquantes dans l'objet `mydata`.


```{r explorer-les-donnes-4, exercise = TRUE}

```

```{r explorer-les-donnes-4-hint-1, eval = FALSE}
plot_missing(...)
```

```{r explorer-les-donnes-4-test, include = FALSE}
plot_missing(mydata)
```

### Exercise 5

L'objet `mydata` contient-il des données manquantes ?

```{r explorer-les-donnes-5}
question_text(NULL,
	answer("non", correct = TRUE),
	allow_retry = TRUE,
	incorrect = "raté",
	rows = 1)
```

### 

Le package DataExplorer nous permet de visualiser rapidement les données et de détecter les valeurs manquantes. Cela nous donne une idée de la qualité des données et des étapes de nettoyage éventuelles à effectuer. Il contient aussi une fonction `create_report()` qui permet de générer un rapport complet sur les données.


## Premiers calculs
Nos données sont dans une `data.table` qui s'appelle `mydata`. Nous allons maintenant effectuer quelques calculs simples sur ces données pour mieux les comprendre.
Comme vous l'avez vu dans l'aide de `data.table`, on peut effectuer des calculs directement dans le champs `j` de `data[ i , j ]`.

### 

### Exercise 1

Dans un premier temps, on va calculer la somme totale des décès.


```{r premiers-calculs-1, exercise = TRUE}

```

```{r premiers-calculs-1-hint-1, eval = FALSE}
mydata[, sum(...)]
```

```{r premiers-calculs-1-test, include = FALSE}
mydata[, sum(incid_dc)]
```

### 

Comme vous le voyez, avec `data.table`, on peut réaliser des opérations de calculs de manière simple et efficace, directement dans le champ des colonnes de la data.table (après la virgule). 


### Exercise 2

On peut aussi en effectuer plusieurs en même temps en les plaçant dans une liste.

Calculez la somme des décès et des hospitalisations.


```{r premiers-calculs-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r premiers-calculs-2-hint-1, eval = FALSE}
mydata[, list(sum(incid_dc), sum(...))]
```

```{r premiers-calculs-2-test, include = FALSE}
mydata[, list(sum(incid_dc), sum(incid_hosp))]
```

### 

Nous savons maintenant qu'il y a eu un total de `r mydata[, sum(incid_hosp)]` hospitalisations et `r mydata[, sum(incid_dc)]` décès liés au Covid-19 en France sur la période concernée.
Il serait intéressant d'avoir ces informations par département pour mieux comprendre la situation et visualiser d'éventuelles disparités.


### Exercise 3

Avec `data.table`, on peut facilement faire des calculs par groupe. Il suffit d'utiliser l'argument `by` pour spécifier la colonne par laquelle on veut grouper les données. Dans notre cas la colonne à utiliser est `dep`.
Calculez la somme des décès et des hospitalisations par département.

```{r premiers-calculs-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r premiers-calculs-3-hint-1, eval = FALSE}

```

```{r premiers-calculs-3-test, include = FALSE}
mydata[, list(sum(incid_dc), sum(incid_hosp)), by = "dep"]
```

### 

Nous allons réutiliser ces calculs dans le reste de ce tutoriel. Il serait donc utile de les stocker dans un objet pour pouvoir les réutiliser facilement, et de nommer les colonnes pour plus de clarté.

### Exercise 4

Stockez les résultats des calculs précédents dans un objet nommé `deces_hosp_par_dep` et nommez les colonnes `deces` et `hospitalisations`. Tapez le nom du nouvel objet à la fin de votre code pour voir le résultat.

```{r premiers-calculs-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r premiers-calculs-4-hint-1, eval = FALSE}

```

```{r premiers-calculs-4-test, include = FALSE}
deces_hosp_par_dep = mydata[, list(deces = sum(incid_dc), hospitalisations = sum(incid_hosp)), by = "dep"]
deces_hosp_par_dep
```

### 

## Visualisation de données géographiques
###

On récupère les données géographiques.


```{r}
library(geodata)
library(sf)
fr_map = geodata::gadm("FRA", path = ".", level=2)

sf_fr_map = st_as_sf(fr_map)

```

Ce qui nous permet de créer une carte.
```{r}


ggplot() + geom_sf(data = sf_fr_map, fill = "white", color = "black") 
```


```{r download-answers, child = system.file("child_documents/download_answers.Rmd", package = "tutorial.helpers")}
```
